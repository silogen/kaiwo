apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-vcluster-config
  namespace: ${NAMESPACE}  # Will be templated/replaced with actual vCluster namespace
data:
  config.alloy: |
    // ============================================================================
    // Remote Write Endpoints - Send to host cluster monitoring namespace
    // ============================================================================

    loki.write "host_loki" {
      endpoint {
        // Using direct Loki pod IP to avoid vCluster DNS issues
        // TODO: Update this IP if Loki pod is recreated
        url = "http://10.42.1.233:3100/loki/api/v1/push"
        // No auth for internal cluster communication
      }
      external_labels = {
        cluster = "vcluster",
        vcluster_namespace = env("VCLUSTER_NAMESPACE"),
        github_run_id = env("GITHUB_RUN_ID"),
        github_run_attempt = env("GITHUB_RUN_ATTEMPT"),
        installer = env("INSTALLER"),
      }
    }

    prometheus.remote_write "host_prometheus" {
      endpoint {
        // Using direct Prometheus pod IP to avoid vCluster DNS issues
        // TODO: Update this IP if Prometheus pod is recreated
        url = "http://10.42.1.140:9090/api/v1/write"
      }
      external_labels = {
        cluster = "vcluster",
        vcluster_namespace = env("VCLUSTER_NAMESPACE"),
        github_run_id = env("GITHUB_RUN_ID"),
        github_run_attempt = env("GITHUB_RUN_ATTEMPT"),
        installer = env("INSTALLER"),
      }
    }

    // ============================================================================
    // Pod Log Collection - All namespaces in vCluster
    // ============================================================================

    discovery.kubernetes "pods" {
      role = "pod"
    }

    discovery.relabel "pod_logs" {
      targets = discovery.kubernetes.pods.targets

      // Add pod metadata as labels
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "node"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_label_app"]
        target_label  = "app"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
        target_label  = "app_name"
      }

      // Add log type label
      rule {
        target_label = "log_type"
        replacement  = "pod_log"
      }
    }

    loki.source.kubernetes "pod_logs" {
      targets    = discovery.relabel.pod_logs.output
      forward_to = [loki.process.pod_logs.receiver]
    }

    // Process and enrich pod logs
    loki.process "pod_logs" {
      forward_to = [loki.write.host_loki.receiver]

      // Extract JSON logs if present
      stage.json {
        expressions = {
          level = "level",
          msg   = "msg",
          time  = "time",
        }
      }

      // Promote extracted fields to labels
      stage.labels {
        values = {
          level = "",
        }
      }

      // Drop noisy health check logs
      stage.match {
        selector = "{app=\"kube-probe\"}"
        action   = "drop"
      }

      // Drop Prometheus scrape logs
      stage.match {
        selector = "{container=\"prometheus\"} |~ \"GET /metrics\""
        action   = "drop"
      }
    }

    // ============================================================================
    // Kubernetes Events Collection
    // ============================================================================

    loki.source.kubernetes_events "cluster_events" {
      job_name   = "integrations/kubernetes/eventhandler"
      log_format = "logfmt"
      forward_to = [loki.process.events.receiver]
    }

    loki.process "events" {
      forward_to = [loki.write.host_loki.receiver]

      // Add log type
      stage.static_labels {
        values = {
          log_type = "k8s_event",
        }
      }
    }

    // ============================================================================
    // Audit Logs - Collected by Host Alloy
    // ============================================================================
    // Note: Audit logs are collected by the host Alloy from vCluster pod logs
    // No webhook receiver needed in vCluster Alloy

    // ============================================================================
    // Metrics Collection - Operator
    // ============================================================================

    // Discover ServiceMonitors
    discovery.kubernetes "servicemonitors" {
      role = "service"
      namespaces {
        names = ["kaiwo-system"]
      }
      selectors {
        role = "service"
        label = "control-plane=controller-manager"
      }
    }

    prometheus.scrape "operator_metrics" {
      targets = discovery.kubernetes.servicemonitors.targets
      forward_to = [prometheus.remote_write.host_prometheus.receiver]
      scrape_interval = "30s"

      clustering {
        enabled = false
      }
    }

    // ============================================================================
    // Metrics Collection - kube-state-metrics
    // ============================================================================

    discovery.kubernetes "kube_state_metrics" {
      role = "service"
      namespaces {
        names = ["kube-system"]
      }
      selectors {
        role = "service"
        label = "app.kubernetes.io/name=kube-state-metrics"
      }
    }

    prometheus.scrape "kube_state_metrics" {
      targets = discovery.kubernetes.kube_state_metrics.targets
      forward_to = [prometheus.remote_write.host_prometheus.receiver]
      scrape_interval = "30s"

      clustering {
        enabled = false
      }
    }

    // ============================================================================
    // Metrics Collection - KubeRay Operator
    // ============================================================================

    discovery.kubernetes "kuberay_operator" {
      role = "service"
      namespaces {
        names = ["kuberay-operator"]
      }
      selectors {
        role = "service"
        label = "app.kubernetes.io/name=kuberay-operator"
      }
    }

    prometheus.scrape "kuberay_metrics" {
      targets = discovery.kubernetes.kuberay_operator.targets
      forward_to = [prometheus.remote_write.host_prometheus.receiver]
      scrape_interval = "30s"

      clustering {
        enabled = false
      }
    }

    // ============================================================================
    // Metrics Collection - Ray Clusters (workload metrics)
    // ============================================================================

    discovery.kubernetes "ray_clusters" {
      role = "pod"
      selectors {
        role = "pod"
        label = "ray.io/node-type=head"
      }
    }

    discovery.relabel "ray_head_nodes" {
      targets = discovery.kubernetes.ray_clusters.targets

      // Only scrape Ray head nodes with metrics port
      rule {
        source_labels = ["__meta_kubernetes_pod_container_port_number"]
        regex         = "8080"
        action        = "keep"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "ray_cluster"
      }

      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }
    }

    prometheus.scrape "ray_clusters" {
      targets = discovery.relabel.ray_head_nodes.output
      forward_to = [prometheus.remote_write.host_prometheus.receiver]
      scrape_interval = "30s"
      metrics_path = "/metrics"

      clustering {
        enabled = false
      }
    }

    // ============================================================================
    // Metrics Collection - Kueue
    // ============================================================================

    discovery.kubernetes "kueue" {
      role = "service"
      namespaces {
        names = ["kueue-system"]
      }
      selectors {
        role = "service"
        label = "control-plane=controller-manager"
      }
    }

    prometheus.scrape "kueue_metrics" {
      targets = discovery.kubernetes.kueue.targets
      forward_to = [prometheus.remote_write.host_prometheus.receiver]
      scrape_interval = "30s"

      clustering {
        enabled = false
      }
    }
