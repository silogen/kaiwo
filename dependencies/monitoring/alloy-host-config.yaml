apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-host-config
  namespace: test-observability
data:
  config.alloy: |
    // Prometheus remote write endpoint
    prometheus.remote_write "default" {
      endpoint {
        url = "http://kube-prometheus-stack-prometheus.test-observability.svc.cluster.local:9090/api/v1/write"
      }
    }

    // ============================================================================
    // AMD GPU Metrics Collection
    // ============================================================================
    // Scrape AMD GPU OpenTelemetry collector
    prometheus.scrape "amd_gpu_metrics" {
      targets = [
        {
          "__address__" = "default-metrics-exporter.kube-amd-gpu.svc.cluster.local:5000",
          "job" = "amd-gpu-exporter",
          "gpu_type" = "amd",
        },
      ]
      forward_to = [prometheus.remote_write.default.receiver]
      scrape_interval = "10s"
    }

    // ============================================================================
    // NVIDIA GPU Metrics Collection (Mock for testing)
    // ============================================================================
    // Scrape NVIDIA DCGM exporter (mock in test environments)
    prometheus.scrape "nvidia_gpu_metrics" {
      targets = discovery.kubernetes.services.targets
      forward_to = [prometheus.remote_write.default.receiver]
      scrape_interval = "10s"
    }

    discovery.kubernetes "services" {
      role = "service"
      namespaces {
        names = ["gpu-operator"]
      }
      selectors {
        role = "service"
        label = "app=nvidia-dcgm-exporter"
      }
    }

    // ============================================================================
    // Host Node Metrics - kubelet/cAdvisor
    // ============================================================================
    discovery.kubernetes "nodes" {
      role = "node"
    }

    // Scrape kubelet metrics
    prometheus.scrape "kubelet" {
      targets    = discovery.kubernetes.nodes.targets
      scheme     = "https"
      bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      tls_config {
        ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
        insecure_skip_verify = true
      }
      forward_to = [prometheus.remote_write.default.receiver]
      scrape_interval = "30s"
    }

    // Scrape cAdvisor metrics from kubelet
    prometheus.scrape "cadvisor" {
      targets    = discovery.kubernetes.nodes.targets
      scheme     = "https"
      metrics_path = "/metrics/cadvisor"
      bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      tls_config {
        ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
        insecure_skip_verify = true
      }
      forward_to = [prometheus.remote_write.default.receiver]
      scrape_interval = "30s"
    }

    // ============================================================================
    // Node Exporter Metrics - DISABLED
    // Note: Using existing node-exporter from monitoring namespace
    // ============================================================================

    // ============================================================================
    // vCluster Audit Logs Collection
    // ============================================================================
    // Loki remote write endpoint
    loki.write "loki" {
      endpoint {
        url = "http://loki-gateway.test-observability.svc.cluster.local/loki/api/v1/push"
      }
    }

    // Discover vCluster pods
    discovery.kubernetes "vcluster_pods" {
      role = "pod"
      selectors {
        role = "pod"
        label = "app=vcluster"
      }
    }

    discovery.relabel "vcluster_logs" {
      targets = discovery.kubernetes.vcluster_pods.targets

      // Extract namespace as vcluster_namespace label
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "vcluster_namespace"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }
    }

    // Collect vCluster pod logs
    loki.source.kubernetes "vcluster_logs" {
      targets    = discovery.relabel.vcluster_logs.output
      forward_to = [loki.process.audit_logs.receiver]
    }

    // Process and parse audit logs
    loki.process "audit_logs" {
      forward_to = [loki.write.loki.receiver]

      // Only process lines that look like audit logs (start with {"kind":"Event")
      stage.match {
        selector = "{container=\"vcluster\"}"

        // Look for audit log JSON
        stage.regex {
          expression = "^(?P<audit_json>\\{\"kind\":\"Event\".+)$"
        }

        // Parse the audit log JSON
        stage.json {
          source = "audit_json"
          expressions = {
            verb             = "verb",
            user             = "user.username",
            namespace        = "objectRef.namespace",
            resource         = "objectRef.resource",
            name             = "objectRef.name",
            stage            = "stage",
            status_code      = "responseStatus.code",
            request_uri      = "requestURI",
          }
        }

        // Promote fields to labels
        stage.labels {
          values = {
            verb      = "",
            namespace = "",
            resource  = "",
            stage     = "",
          }
        }

        // Add log type label
        stage.static_labels {
          values = {
            log_type = "k8s_audit_log",
          }
        }

        // Replace the log line with just the audit JSON
        stage.output {
          source = "audit_json"
        }
      }

      // Drop non-audit log lines from vCluster
      stage.match {
        selector = "{container=\"vcluster\"}"
        pipeline_name = "drop_non_audit"

        // If it doesn't have the audit_json extracted, drop it
        stage.drop {
          expression = ".*"
          drop_counter_reason = "not_audit_log"
        }
      }
    }
