repos:
- repo: local
  hooks:
  - id: make-generate
    name: Run make generate
    entry: make generate
    language: system
    pass_filenames: false

  - id: make-manifests
    name: Run make manifests
    entry: make manifests
    language: system
    pass_filenames: false

  - id: build-crds
    name: Build CRDs for Helm chart
    entry: bash -lc 'kubectl kustomize config/crd/ > crd/crds.yaml'
    language: system
    pass_filenames: false

  - id: make-generate-crd-docs
    name: Run make generate-crd-docs
    entry: make generate-crd-docs
    language: system
    pass_filenames: false

  - id: golangci-lint
    name: golangci-lint
    description: Fast linters runner for Go. Note that only modified files are linted, so linters like 'unused' that need to scan all files won't work as expected.
    entry: golangci-lint run --timeout 10m
    types: [go]
    language: golang
    require_serial: true
    pass_filenames: false

  - id: derive-versions
    name: Derive image and chart versions
    entry: >
      bash -c "
        set -euo pipefail;
        SHORT_SHA=$(git rev-parse --short=7 HEAD);
        IMAGE_TAG=\"main-${SHORT_SHA}\";
        CHART_VERSION=\"0.0.0-main.${SHORT_SHA}\";
        echo SHORT_SHA=${SHORT_SHA} > .precommit_env;
        echo IMAGE_TAG=${IMAGE_TAG} >> .precommit_env;
        echo CHART_VERSION=${CHART_VERSION} >> .precommit_env;
        echo 'Derived versions:';
        cat .precommit_env;
      "
    language: system
    pass_filenames: false
    stages: [pre-commit]

  - id: build-install-yaml
    name: Generate install.yaml
    entry: >
      bash -c "
        set -euo pipefail;
        source .precommit_env;
        make build-installer TAG=${IMAGE_TAG};
        cp dist/install.yaml install.yaml;
      "
    language: system
    pass_filenames: false
    stages: [pre-commit]

  - id: helm-package
    name: Package Helm chart
    entry: >
      bash -c "
        set -euo pipefail;
        source .precommit_env;
        make helm-release TAG=${IMAGE_TAG} CHART_VERSION=${CHART_VERSION};
      "
    language: system
    pass_filenames: false
    stages: [pre-commit]

- repo: https://github.com/jumanjihouse/pre-commit-hook-yamlfmt
  rev: 0.2.3
  hooks:
  - id: yamlfmt
    args: [--offset, "0", --sequence, "2", --mapping, "2", "--width", "4096", "--preserve-quotes", "--implicit_start", "--preserve_null"]
    exclude: "(^config/prometheus/.*\\.ya?ml$)|(^docs/mkdocs\\.ya?ml$)|(^config/crd/.*\\.ya?ml$)|(^crd/.*\\.ya?ml$)|(^chart/templates/.*\\.(ya?ml|tpl)$)|(^.*/templates/.*\\.(ya?ml|tpl)$)"

- repo: https://github.com/psf/black
  rev: 25.1.0
  hooks:
  - id: black
    additional_dependencies: ["toml"]
    args: ["--config", "python/pyproject.toml"]

- repo: https://github.com/pycqa/isort
  rev: 6.0.1
  hooks:
  - id: isort
    additional_dependencies: ["toml"]
    args: ["--settings", "python/pyproject.toml"]

- repo: https://github.com/pycqa/flake8
  rev: 7.1.2
  hooks:
  - id: flake8
    additional_dependencies: ["flake8-pyproject"]
    args: ["--config", "python/.flake8"]
