name: recreate-kind

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
  pull_request:
    paths-ignore:
      - 'docs/**'
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Snapshot version tag to restore (e.g., v1.0.0)'
        required: false
        default: '0.1'
        type: string
      num_workers:
        description: 'Number of worker nodes'
        required: false
        default: '5'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

env:
  CLUSTER_NAME: kaiwo-test
  REPO_URL: ghcr.io/silogen/kaiwo
  # Defaults for auto-triggered runs (push/PR)
  DEFAULT_VERSION_TAG: '0.1'
  DEFAULT_NUM_WORKERS: '5'

jobs:
  recreate-kind:
    name: Recreate Kind cluster from snapshot
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        shell: bash
        run: |
          set -euo pipefail
          TARGETS=(
            "/usr/local/lib/android"
            "/usr/share/dotnet"
            "/opt/ghc"
            "/opt/hostedtoolcache"
            "/usr/local/share/boost"
            "/usr/local/share/powershell"
            "/usr/share/swift"
          )
          echo "Deleting large preinstalled SDKs/tools..."
          for d in "${TARGETS[@]}"; do
            if [[ -e "$d" ]]; then
              sudo rm -rf "$d" >/dev/null 2>&1 &
            fi
          done
          docker system prune -af --volumes || true
          wait

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Install kind CLI
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.26.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Recreate Kind cluster from snapshot
        env:
          # Use inputs if available (manual dispatch), otherwise use defaults
          VERSION_TAG: ${{ inputs.version_tag || env.DEFAULT_VERSION_TAG }}
          NUM_WORKERS: ${{ inputs.num_workers || env.DEFAULT_NUM_WORKERS }}
        run: |
          chmod +x ./test/scripts/*.sh
          echo "Restoring snapshot: $VERSION_TAG with $NUM_WORKERS workers"
          time ./test/scripts/recreate_kind.sh "$VERSION_TAG" "$NUM_WORKERS"

      - name: Verify cluster health
        run: |
          export KUBECONFIG="$(pwd)/kaiwo_test_kubeconfig.yaml"
          echo "=== Node status ==="
          kubectl get nodes -o wide
          echo ""
          echo "=== Pod status (all namespaces) ==="
          kubectl get pods -A
          echo ""
          echo "=== Kueue status ==="
          kubectl get pods -n kueue-system
          kubectl get clusterqueue || true

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Docker containers ==="
          docker ps -a
          echo ""
          echo "=== Kind clusters ==="
          kind get clusters || true
          echo ""
          echo "=== Docker logs (control-plane) ==="
          docker logs kaiwo-test-control-plane 2>&1 | tail -100 || true