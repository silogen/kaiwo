name: publish-main

on:
  pull_request_review:
    types: [submitted]
    paths:
    - 'apis/**'
    - 'internal/**'
    - 'pkg/**'
    - 'cmd/**'
    - 'config/**'

permissions:
  contents: write
  packages: write

jobs:
  publish:
    if: github.event.review.state == 'approved'
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/kaiwo-operator
      CHART_NAME: kaiwo-operator

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # - name: Set up Go
    #   uses: actions/setup-go@v4
    #   with:
    #     go-version: '1.21'

    # - name: Set up Helm
    #   uses: azure/setup-helm@v4.3.1

    # - name: Derive versions (image + chart)
    #   id: ver
    #   shell: bash
    #   run: |
    #     SHORT_SHA="${GITHUB_SHA::7}"
    #     IMAGE_TAG="main-${SHORT_SHA}"
    #     CHART_VERSION="0.0.0-main.${SHORT_SHA}"
    #     {
    #       echo "SHORT_SHA=${SHORT_SHA}"
    #       echo "IMAGE_TAG=${IMAGE_TAG}"
    #       echo "CHART_VERSION=${CHART_VERSION}"
    #     } >> "$GITHUB_ENV"
    #     {
    #       echo "short_sha=${SHORT_SHA}"
    #       echo "image_tag=${IMAGE_TAG}"
    #       echo "chart_version=${CHART_VERSION}"
    #     } >> "$GITHUB_OUTPUT"

    # - name: Log in to GHCR (docker)
    #   run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

    # - name: Build and push operator image
    #   run: |
    #     make docker-build IMG=${IMAGE_REPO}:${IMAGE_TAG}
    #     make docker-push  IMG=${IMAGE_REPO}:${IMAGE_TAG}
    #     docker tag ${IMAGE_REPO}:${IMAGE_TAG} ${IMAGE_REPO}:main
    #     docker push ${IMAGE_REPO}:main

    # - name: Generate install.yaml
    #   run: |
    #     make build-installer TAG=${IMAGE_TAG}
    #     cp dist/install.yaml install.yaml

    # - name: Package Helm chart
    #   run: |
    #     make helm-release TAG=${IMAGE_TAG} CHART_VERSION=${CHART_VERSION}


    # - name: Log in to GHCR (Helm/OCI)
    #   run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u $GITHUB_ACTOR --password-stdin


    # - name: Commit and push local chart files (Verified)
    #   shell: bash
    #   env:
    #     GH_BRANCH: ${{ github.event.pull_request.head.ref || github.ref_name }}
    #     GH_REPO: ${{ github.repository }}
    #     CHART_VERSION: ${{ env.CHART_VERSION }}
    #   if: ${{ (github.event_name != 'pull_request') || (github.event.pull_request.head.repo.full_name == github.repository) }}
    #   run: |
    #     set -euo pipefail
    #     # configure commit identity
    #     git config user.name "github-actions[bot]"
    #     git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

    #     # Ensure we have the branch
    #     git fetch origin "${GH_BRANCH}:${GH_BRANCH}" || true
    #     git checkout "${GH_BRANCH}"

    #     git add chart/Chart.yaml || true
    #     git commit -m "ci: Update local Helm chart and CRDs to ${CHART_VERSION}"
    #     # push back to the same branch
    #     git push origin "HEAD:${GH_BRANCH}"
    #     echo "Pushed commit to ${GH_REPO}@${GH_BRANCH}"
