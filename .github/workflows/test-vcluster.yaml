name: test-vcluster

on:
  pull_request: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

env:
  TTL_TAG: 1h
  GO_VERSION_FILE: go.mod
  GOLANGCI_LINT_VERSION: v1.61.0
  PY_VERSION: '3.12'
  # Pin tool versions used in E2E (self-hosted only needs these)
  KUBECTL_VERSION: 'v1.30.4'
  VCLUSTER_VERSION: 'v0.20.0'
  HELMFILE_VERSION: 'v1.1.5'

defaults:
  run:
    shell: bash -euo pipefail

jobs:
  lint-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { clean: true }
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          check-latest: true
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: go-${{ runner.os }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-${{ runner.os }}-
      - uses: golangci/golangci-lint-action@v8
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=10m

  lint-python:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./python
    steps:
      - uses: actions/checkout@v4
        with: { clean: true }
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python/requirements-dev.txt'
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - run: flake8 kaiwo
      - run: black --check --diff kaiwo
      - run: isort --check-only --diff kaiwo

  test:
    needs: [lint-go, lint-python]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with: { clean: true }
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          check-latest: true
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: go-${{ runner.os }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-${{ runner.os }}-
      - run: |
          go mod tidy
          make test

  build-image:
    name: Build & push (ttl.sh)
    needs: test
    runs-on: ubuntu-latest   # moved off self-hosted
    timeout-minutes: 25
    outputs:
      image: ${{ steps.vars.outputs.full_image }}
      repo: ${{ steps.vars.outputs.repo }}
      tag: ${{ steps.vars.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with: { clean: true }
      - uses: docker/setup-buildx-action@v3
      - name: Compute ttl.sh image ref
        id: vars
        run: |
          ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
          REPO="ttl.sh/${ID}"
          TAG="${{ env.TTL_TAG }}"
          echo "repo=${REPO}"              >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}"                >> "$GITHUB_OUTPUT"
          echo "full_image=${REPO}:${TAG}" >> "$GITHUB_OUTPUT"
      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.vars.outputs.full_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Build CLI artifact
        run: |
          make build-cli
          make build-log
          mkdir -p builds
          cp bin/kaiwo builds/
      - uses: actions/upload-artifact@v4
        with:
          name: kaiwo-builds
          path: builds
          if-no-files-found: error
          retention-days: 5

  e2e-vcluster:
    name: E2E on vcluster (self-hosted only)
    needs: build-image
    runs-on: self-hosted
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        installer: [kustomization, helm]
    env:
      KUBECONFIG_CONTENT: ${{ secrets.TW038_KUBECONFIG }}
      VCLUSTER_NAMESPACE: kaiwo-test-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.installer }}
      VCLUSTER_NAME: kaiwo-test-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.installer }}
      IMAGE_NAME: ${{ needs.build-image.outputs.image }}
    steps:
      - uses: actions/checkout@v4
        with: { clean: true }

      - name: Set up kubectl (pinned)
        uses: azure/setup-kubectl@v4
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - uses: actions/download-artifact@v4
        with:
          name: kaiwo-builds
          path: builds
      - run: |
          chmod +x builds/kaiwo
          chmod +x builds/log

      - name: Install Chainsaw
        uses: kyverno/action-install-chainsaw@v0.2.12
        with:
          release: v0.2.12

      - name: Install Helmfile (pinned)
        run: |
          curl -L -o helmfile.tar.gz https://github.com/helmfile/helmfile/releases/download/${HELMFILE_VERSION}/helmfile_${HELMFILE_VERSION#v}_linux_amd64.tar.gz
          tar -xzf helmfile.tar.gz && chmod +x ./helmfile && sudo mv ./helmfile /usr/local/bin/helmfile
          rm -f helmfile.tar.gz
          helmfile version

      - name: Write host kubeconfig
        run: |
          echo "$KUBECONFIG_CONTENT" > host-kubeconfig
          KUBECONFIG=$(pwd)/host-kubeconfig kubectl get nodes

      - name: Install vcluster CLI (pinned)
        run: |
          curl -L -o vcluster "https://github.com/loft-sh/vcluster/releases/download/${VCLUSTER_VERSION}/vcluster-linux-amd64"
          chmod +x vcluster && sudo mv vcluster /usr/local/bin/vcluster
          vcluster --version

      - name: Create namespace & vcluster
        env: { KUBECONFIG: host-kubeconfig }
        run: |
          kubectl get ns "$VCLUSTER_NAMESPACE" >/dev/null 2>&1 || kubectl create namespace "$VCLUSTER_NAMESPACE"
          vcluster create "$VCLUSTER_NAME" --namespace "$VCLUSTER_NAMESPACE" --values dependencies/vcluster.yaml --connect=false --update-current=false
          kubectl -n "$VCLUSTER_NAMESPACE" wait --for=condition=ready pod \
            -l app.kubernetes.io/name=vcluster,app.kubernetes.io/instance="$VCLUSTER_NAME" --timeout=5m

      - name: Connect to vcluster
        env: { KUBECONFIG: host-kubeconfig }
        run: |
          vcluster connect "$VCLUSTER_NAME" --namespace "$VCLUSTER_NAMESPACE" --kube-config=./vcluster-kubeconfig --update-current=false --background-timeout=0s
          KUBECONFIG=$(pwd)/vcluster-kubeconfig kubectl get ns

      - name: Install dependencies
        env: { KUBECONFIG: vcluster-kubeconfig }
        run: bash ./dependencies/deploy.sh vcluster up

      - name: Install CRDs and Deploy (${{ matrix.installer }})
        env:
          KUBECONFIG: vcluster-kubeconfig
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: bash ./kaiwo.sh --install-crds --deploy-via=${{ matrix.installer }} up

      - name: Wait for rollout
        env: { KUBECONFIG: vcluster-kubeconfig }
        run: |
          kubectl -n kaiwo-system rollout status deployment/kaiwo-controller-manager --timeout=300s
          kubectl -n kube-system rollout status deployment/kaiwo-scheduler --timeout=300s

      - name: Run E2E tests
        env: { KUBECONFIG: vcluster-kubeconfig }
        run: |
          cd test
          make test-kind CHAINSAW_CONFIG=chainsaw/configs/ci.yaml

      - name: Cleanup
        if: always()
        env: { KUBECONFIG: host-kubeconfig }
        run: |
          vcluster delete "$VCLUSTER_NAME" --namespace "$VCLUSTER_NAMESPACE" || true
          kubectl delete namespace "$VCLUSTER_NAMESPACE" --ignore-not-found=true || true
          rm -f host-kubeconfig vcluster-kubeconfig
