name: lint-and-test
on:
  push:
    branches:
      - main
      - master
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - name: Enable Debug Logging
        run: echo "RUNNER_DEBUG=1" >> $GITHUB_ENV
      - name: Install golangci-lint manually
        run: |
          echo "Installing golangci-lint..."
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.63.4
          echo "PATH=$PATH:$(go env GOPATH)/bin" >> $GITHUB_ENV

      - name: Verify installation
        run: golangci-lint --version

      - name: Run golangci-lint (only changed files)
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.go$' | xargs || echo "all")
          if [ "$CHANGED_FILES" = "all" ]; then
            golangci-lint run --timeout=15m --verbose --concurrency=1
          else
            golangci-lint run --timeout=15m --verbose --concurrency=1 $CHANGED_FILES
          fi
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Running Tests
        run: |
          go mod tidy
          make test

  lint-python:
    name: Lint Python code
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./python
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.12
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Run flake8
        run: flake8 kaiwo
      - name: Run Black
        run : black kaiwo
      - name: Run isort
        run: isort kaiwo

  # test-e2e:
  #   name: Run e2e tests
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Clone the code
  #       uses: actions/checkout@v4

  #     - name: Setup Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version-file: go.mod

  #     - name: Install the latest version of kind
  #       run: |
  #         curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
  #         chmod +x ./kind
  #         sudo mv ./kind /usr/local/bin/kind

  #     - name: Verify kind installation
  #       run: kind version

  #     - name: Create kind cluster
  #       run: kind create cluster

  #     - name: Running Test e2e
  #       run: |
  #         go mod tidy
  #         make test-e2e