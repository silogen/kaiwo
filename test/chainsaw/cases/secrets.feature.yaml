name: Secrets
reference:
  file: _base-object.yaml
rules:
  - name: Secrets are applied to workloads
    background:
      - given: a secret exists
        apply:
          resource:
            apiVersion: v1
            kind: Secret
            metadata:
              name: my-secret
            data:
              my-secret-key: bXktc2VjcmV0LXZhbHVl
      - and: the job waits long enough for the check to pass
        applyPatch:
          spec:
            entrypoint: |
              sleep 10
    scenarios:
      - name: Secrets are applied to Kaiwo jobs
        steps:
          - given: the kaiwo job references the secret
            applyPatch:
              spec:
                secretVolumes:
                  - name: my-secret-volume
                    secretName: my-secret
                    key: my-secret-key
                    mountPath: /secrets
          - when: the pod is running
            assert:
              resource:
                apiVersion: v1
                kind: Pod
                metadata:
                  labels:
                    kaiwo.silogen.ai/type: job
                    kaiwo.silogen.ai/name: secret-volume-mount-job
                status:
                  phase: Running
          - then: the secret exists in the workload pod
            script:
              content: "kaiwo-dev helpers get-file --selector='kaiwo.silogen.ai/type=job,kaiwo.silogen.ai/name=secret-volume-mount-job' --namespace=$NAMESPACE --path=/secrets/my-secret-key"
              env:
                - name: NAMESPACE
                  value: ($namespace)
              check:
                ($stdout == 'my-secret-value'): true