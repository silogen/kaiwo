apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: kaiwoqueueconfig-ensure-no-overwrite
spec:
  concurrent: false
  steps:
  - try:
    - assert:
        timeout: 1s
        resource:
          apiVersion: kaiwo.silogen.ai/v1alpha1
          kind: KaiwoQueueConfig
          metadata:
            name: kaiwo
          spec:
            clusterQueues:
            - name: kaiwo
              spec:
                resourceGroups:
                - ~.(flavors):
                    (name == 'foobaz'): false
    - patch:
        resource:
          apiVersion: config.kaiwo.silogen.ai/v1alpha1
          kind: KaiwoConfig
          metadata:
            name: kaiwo
          spec:
            dynamicallyUpdateDefaultClusterQueue: false
    - apply:
        file: kaiwoqueueconfig.yaml
    - delete:
        ref:
          apiVersion: v1
          kind: Pod
          namespace: kaiwo-system
          labels:
            app.kubernetes.io/name: kaiwo
    - wait:
        apiVersion: apps/v1
        kind: Deployment
        name: kaiwo-controller-manager
        namespace: kaiwo-system
        timeout: 1m
        for:
          condition:
            name: Available
            value: 'true'
    - sleep:
        duration: 10s
    - assert:
        timeout: 1s
        file: kaiwoqueueconfig.yaml
    - patch:
        resource:
          apiVersion: config.kaiwo.silogen.ai/v1alpha1
          kind: KaiwoConfig
          metadata:
            name: kaiwo
          spec:
            dynamicallyUpdateDefaultClusterQueue: true
    - delete:
        ref:
          apiVersion: v1
          kind: Pod
          namespace: kaiwo-system
          labels:
            app.kubernetes.io/name: kaiwo
    - wait:
        apiVersion: apps/v1
        kind: Deployment
        name: kaiwo-controller-manager
        namespace: kaiwo-system
        timeout: 1m
        for:
          condition:
            name: Available
            value: 'true'
    - sleep:
        duration: 10s
    - assert:
        timeout: 1s
        resource:
          apiVersion: kaiwo.silogen.ai/v1alpha1
          kind: KaiwoQueueConfig
          metadata:
            name: kaiwo
          spec:
            clusterQueues:
            - name: kaiwo
              spec:
                resourceGroups:
                - ~.(flavors):
                    (name == 'foobaz'): false   
    catch:
    - command:
        entrypoint: ls
        