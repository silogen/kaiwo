apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: basic-kvcache
spec:
  description: Basic AIMKVCache creation with default Redis backend
  concurrent: true
  timeouts:
    assert: 60s
  steps:
  - name: Create basic AIMKVCache
    try:
    - apply:
        file: kvcache.yaml
    
  - name: Verify StatefulSet is created
    try:
    - assert:
        timeout: 10s
        resource:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: test-kvcache-redis
          spec:
            replicas: 1
            serviceName: test-kvcache-redis-svc

  - name: Verify Service is created
    try:
    - assert:
        timeout: 10s
        resource:
          apiVersion: v1
          kind: Service
          metadata:
            name: test-kvcache-redis-svc
          spec:
            clusterIP: None
            ports:
            - port: 6379
              name: redis

  - name: Verify AIMKVCache becomes Ready
    try:
    - assert:
        timeout: 60s
        resource:
          apiVersion: aim.silogen.ai/v1alpha1
          kind: AIMKVCache
          metadata:
            name: test-kvcache
          status:
            status: Ready
            readyReplicas: 1

  - name: Verify endpoint is populated
    try:
    - assert:
        timeout: 5s
        resource:
          apiVersion: aim.silogen.ai/v1alpha1
          kind: AIMKVCache
          metadata:
            name: test-kvcache
          status:
            endpoint: redis://test-kvcache-redis-svc:6379

  - name: Verify Ready condition is True
    try:
    - assert:
        timeout: 5s
        resource:
          apiVersion: aim.silogen.ai/v1alpha1
          kind: AIMKVCache
          metadata:
            name: test-kvcache
          status:
            (conditions[?type == 'Ready']):
            - status: "True"
              reason: StatefulSetReady


