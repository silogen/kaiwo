apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: kvcache-preexisting-no-update
spec:
  description: AIMService does NOT update pre-existing KVCache when referencing with different settings
  timeouts:
    assert: 120s
  steps:
  - name: Create standalone KVCache first
    try:
    - apply:
        file: preexisting-kvcache.yaml

  - name: Verify pre-existing KVCache becomes Ready with initial config
    try:
    - assert:
        timeout: 90s
        resource:
          apiVersion: aim.silogen.ai/v1alpha1
          kind: AIMKVCache
          metadata:
            name: preexisting-shared-cache
          status:
            status: Ready
            readyReplicas: 1

  - name: Verify pre-existing KVCache has 1 CPU
    try:
    - assert:
        timeout: 30s
        resource:
          apiVersion: aim.silogen.ai/v1alpha1
          kind: AIMKVCache
          metadata:
            name: preexisting-shared-cache
          spec:
            resources:
              requests:
                cpu: "1"
                memory: "1Gi"

  - name: Ensure default cluster model is available
    try:
    - assert:
        timeout: 5s
        file: ../../service/_shared/default-cluster-image.yaml

  - name: Ensure default template is available
    try:
    - assert:
        timeout: 5s
        file: ../../service/_shared/template-available.yaml

  - name: Create AIMService that references existing KVCache with DIFFERENT settings
    try:
    - apply:
        file: service-referencing-existing.yaml

  - name: Wait a moment for any potential changes to propagate
    try:
    - sleep:
        duration: 5s

  - name: Verify KVCache resources remain UNCHANGED (still 1 CPU, not 4 CPU)
    try:
    - assert:
        timeout: 30s
        resource:
          apiVersion: aim.silogen.ai/v1alpha1
          kind: AIMKVCache
          metadata:
            name: preexisting-shared-cache
          spec:
            kvCacheType: redis
            resources:
              requests:
                cpu: "1"
                memory: "1Gi"
              limits:
                cpu: "1"
                memory: "1Gi"

  - name: Verify StatefulSet resources remain UNCHANGED
    try:
    - assert:
        timeout: 30s
        resource:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: preexisting-shared-cache-redis
          spec:
            template:
              spec:
                containers:
                - name: redis
                  resources:
                    requests:
                      cpu: "1"
                      memory: "1Gi"
                    limits:
                      cpu: "1"
                      memory: "1Gi"

  - name: Verify AIMService successfully uses the existing KVCache
    try:
    - assert:
        timeout: 30s
        resource:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: lmcache-service-referencing-existing
          data:
            lmcache_config.yaml: |
              local_cpu: true
              chunk_size: 50
              max_local_cpu_size: 1.0
              remote_url: "redis://preexisting-shared-cache-redis-svc:6379"
              remote_serde: "naive"

