apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: kvcache-shared
spec:
  description: Multiple AIMServices can share the same AIMKVCache instance
  timeouts:
    assert: 120s
  steps:
  - name: Ensure default cluster model is available
    try:
    - assert:
        timeout: 5s
        file: ../../service/_shared/default-cluster-image.yaml

  - name: Ensure default template is available
    try:
    - assert:
        timeout: 5s
        file: ../../service/_shared/template-available.yaml

  - name: Create shared AIMKVCache
    try:
    - apply:
        file: shared-kvcache.yaml

  - name: Verify shared KVCache becomes Ready
    try:
    - assert:
        timeout: 90s
        resource:
          apiVersion: aim.silogen.ai/v1alpha1
          kind: AIMKVCache
          metadata:
            name: shared-kvcache
          status:
            status: Ready
            endpoint: redis://shared-kvcache-redis-svc:6379

  - name: Create first AIMService using shared KVCache
    try:
    - apply:
        file: service-1.yaml

  - name: Create second AIMService using shared KVCache
    try:
    - apply:
        file: service-2.yaml

  - name: Verify first service LMCache ConfigMap references shared KVCache
    try:
    - assert:
        timeout: 30s
        resource:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: lmcache-shared-service-1
            ownerReferences:
            - name: shared-service-1
              kind: AIMService
          data:
            lmcache_config.yaml: |
              local_cpu: true
              chunk_size: 50
              max_local_cpu_size: 1.0
              remote_url: "redis://shared-kvcache-redis-svc:6379"
              remote_serde: "naive"

  - name: Verify second service LMCache ConfigMap references shared KVCache
    try:
    - assert:
        timeout: 30s
        resource:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: lmcache-shared-service-2
            ownerReferences:
            - name: shared-service-2
              kind: AIMService
          data:
            lmcache_config.yaml: |
              local_cpu: true
              chunk_size: 50
              max_local_cpu_size: 1.0
              remote_url: "redis://shared-kvcache-redis-svc:6379"
              remote_serde: "naive"

  - name: Verify both InferenceServices are created with LMCache config
    try:
    - assert:
        timeout: 30s
        resource:
          apiVersion: serving.kserve.io/v1beta1
          kind: InferenceService
          metadata:
            name: shared-service-1
          spec:
            predictor:
              model:
                env:
                - name: AIM_CACHE_PATH
                  value: /workspace/model-cache
                - name: LMCACHE_USE_EXPERIMENTAL
                  value: "True"
                - name: LMCACHE_CONFIG_FILE
                  value: /lmcache/lmcache_config.yaml
                - name: LMCACHE_LOG_LEVEL
                  value: INFO
                - name: AIM_ENGINE_ARGS
                  value: '{"kv-transfer-config": {"kv_connector":"LMCacheConnectorV1", "kv_role":"kv_both"}}'
    - assert:
        timeout: 30s
        resource:
          apiVersion: serving.kserve.io/v1beta1
          kind: InferenceService
          metadata:
            name: shared-service-2
          spec:
            predictor:
              model:
                env:
                - name: AIM_CACHE_PATH
                  value: /workspace/model-cache
                - name: LMCACHE_USE_EXPERIMENTAL
                  value: "True"
                - name: LMCACHE_CONFIG_FILE
                  value: /lmcache/lmcache_config.yaml
                - name: LMCACHE_LOG_LEVEL
                  value: INFO
                - name: AIM_ENGINE_ARGS
                  value: '{"kv-transfer-config": {"kv_connector":"LMCacheConnectorV1", "kv_role":"kv_both"}}'

  - name: Verify shared KVCache StatefulSet still has only 1 replica
    try:
    - assert:
        timeout: 10s
        resource:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: shared-kvcache-redis
          spec:
            replicas: 1
          status:
            readyReplicas: 1

