apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: auto-sourcing-cluster-models
spec:
  description: Test AIMClusterModelSource creates 8 ready cluster models from registry
  concurrent: False
  steps:
  - name: Create AIMClusterModelSource
    try:
    - apply:
        file: cluster-model-source.yaml

  - name: Wait for exactly 8 models to be created
    try:
    - script:
        timeout: 5m
        content: |
          set -e
          # Wait for exactly 8 AIMClusterModels to be created
          echo "Waiting for models to be discovered and created..."
          i=1
          while [ $i -le 60 ]; do
            count=$(kubectl get aimclustermodels --no-headers 2>/dev/null | wc -l || echo "0")
            echo "Attempt $i/60: Found $count AIMClusterModels (waiting for 8)..."
            if [ "$count" -eq 8 ]; then
              echo "✓ Exactly 8 AIMClusterModels created"
              exit 0
            fi
            sleep 5
            i=$((i + 1))
          done
          echo "✗ Expected 8 AIMClusterModels, found $count"
          kubectl get aimclustermodels 2>/dev/null || echo "No models found"
          exit 1

  - name: Wait for all 8 models to become Ready
    try:
    - script:
        timeout: 5m
        content: |
          set -e
          # Wait for all models to become Ready (none stuck in Progressing)
          i=1
          while [ $i -le 60 ]; do
            ready=$(kubectl get aimclustermodels -o json | jq -r '.items[] | select(.status.status == "Ready") | .metadata.name' | wc -l)
            progressing=$(kubectl get aimclustermodels -o json | jq -r '.items[] | select(.status.status == "Progressing") | .metadata.name' | wc -l)
            total=$(kubectl get aimclustermodels --no-headers | wc -l)

            echo "Attempt $i/60: Models: $ready Ready, $progressing Progressing (total $total)"

            if [ "$ready" -eq 8 ] && [ "$progressing" -eq 0 ]; then
              echo "✓ All 8 models are Ready, none stuck in Progressing"
              exit 0
            fi

            # Show which models are stuck
            if [ "$progressing" -gt 0 ]; then
              echo "Models stuck in Progressing:"
              kubectl get aimclustermodels -o json | jq -r '.items[] | select(.status.status == "Progressing") | .metadata.name'
            fi

            sleep 5
            i=$((i + 1))
          done

          echo "✗ Expected all 8 models Ready, got $ready Ready and $progressing Progressing"
          kubectl get aimclustermodels
          exit 1

  - name: Verify auto-generated templates become Ready
    try:
    - script:
        timeout: 5m
        content: |
          set -e
          # Wait for auto-generated templates to become Ready (none stuck in Pending)
          i=1
          while [ $i -le 60 ]; do
            ready=$(kubectl get aimclusterservicetemplates -l aim.silogen.ai/auto-generated=true -o json | jq -r '.items[] | select(.status.status == "Ready") | .metadata.name' | wc -l)
            pending=$(kubectl get aimclusterservicetemplates -l aim.silogen.ai/auto-generated=true -o json | jq -r '.items[] | select(.status.status == "Pending") | .metadata.name' | wc -l)
            total=$(kubectl get aimclusterservicetemplates -l aim.silogen.ai/auto-generated=true --no-headers | wc -l)

            echo "Attempt $i/60: Templates: $ready Ready, $pending Pending (total $total)"

            # We expect at least 8 templates (2 per model minimum), all Ready
            if [ "$ready" -ge 8 ] && [ "$pending" -eq 0 ]; then
              echo "✓ All auto-generated templates are Ready (>= 8), none stuck in Pending"
              exit 0
            fi

            # Show which templates are stuck
            if [ "$pending" -gt 0 ]; then
              echo "Templates stuck in Pending:"
              kubectl get aimclusterservicetemplates -l aim.silogen.ai/auto-generated=true -o json | jq -r '.items[] | select(.status.status == "Pending") | .metadata.name'
            fi

            sleep 5
            i=$((i + 1))
          done

          echo "✗ Expected all templates Ready with none Pending, got $ready Ready and $pending Pending"
          kubectl get aimclusterservicetemplates -l aim.silogen.ai/auto-generated=true
          exit 1
