apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: cluster-image-caching
spec:
  description: Test that adding a cluster image with caching enabled in the config results in a DaemonSet cacher
  concurrent: false
  timeouts:
    assert: 30s
  steps:
  - name: Create the config
    try:
    - apply:
        file: config.yaml
    - apply:
        file: cluster-image.yaml
    - sleep:
        duration: 30s
    - assert:
        resource:
          apiVersion: aim.silogen.ai/v1alpha1
          kind: AIMBaseImageCache
          metadata:
            name: aimbic-bed06e2f71
          spec:
            image: ghcr.io/silogen/aim:0.4.0-meta-llama-llama-3.1-8b-instruct-v20251006
    - assert:
        resource:
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: aimbic-bed06e2f71
            namespace: kaiwo-system
