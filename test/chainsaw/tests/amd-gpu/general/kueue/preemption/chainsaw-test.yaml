apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: kueue-gpu-preemption
spec:
  concurrent: false
  steps:
  - name: Create resources
    try:
    - apply:
        file: cluster-queue.yaml
  - name: Deployment
    try:
    - description: Create first job in queue 1
      apply:
        file: kaiwojob-queue-1-1.yaml
    - description: Create second job in queue 1, which borrows from queue 2
      apply:
        file: kaiwojob-queue-1-2.yaml
    - assert:
        resource:
          apiVersion: kueue.x-k8s.io/v1beta1
          kind: ClusterQueue
          metadata:
            name: queue-1
          status:
            pendingWorkloads: 0
            admittedWorkloads: 2
    - description: Create first job in queue 2, which should reclaim a workload from queue 1, and push the second workload to pending
      apply:
        file: kaiwojob-queue-2-1.yaml
    - assert:
        resource:
          apiVersion: kueue.x-k8s.io/v1beta1
          kind: ClusterQueue
          metadata:
            name: queue-1
          status:
            pendingWorkloads: 1
            admittedWorkloads: 1
    - assert:
        resource:
          apiVersion: kueue.x-k8s.io/v1beta1
          kind: ClusterQueue
          metadata:
            name: queue-2
          status:
            pendingWorkloads: 0
            admittedWorkloads: 1
    finally:
    - script:
        content: kubectl delete kaiwoqueueconfig kaiwo
