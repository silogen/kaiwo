apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: amd-gpu-partitioning-setup
spec:
  concurrent: false
  steps:
  - name: Label the node and trigger the partitioning
    try:
    - script:
        env:
        - name: NODE_NAME
          value: ($values.amd_gpu_partitioning_node_name)
        content: kubectl label nodes $NODE_NAME --overwrite kaiwo.silogen.ai/node.amd.partitioning.enabled=true kaiwo.silogen.ai/node.amd.partitioning.profile=cpx
    - wait:
        apiVersion: kaiwo.silogen.ai/v1alpha1
        kind: KaiwoNode
        name: ($values.amd_gpu_partitioning_node_name)
        timeout: 5m
        for:
          condition:
            name: PartitioningCompleted
            value: 'true'
    - assert:
        timeout: 300s
        resource:
          apiVersion: kaiwo.silogen.ai/v1alpha1
          kind: KaiwoNode
          metadata:
            name: ($values.amd_gpu_partitioning_node_name)
          spec:
            partitioning:
              profile: cpx
          status:
            status: Ready
            partitioning:
              phase: Completed
              appliedProfile: cpx
    - script:
        content: kubectl delete kaiwoqueueconfig kaiwo
