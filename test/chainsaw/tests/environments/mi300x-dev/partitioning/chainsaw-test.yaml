apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: monitoring-conditions-gpu
spec:
  concurrent: false
  steps:
  - name: Ensure partitioning is enabled
    try:
      - script:
          content: kubectl label nodes tw009 --overwrite kaiwo.silogen.ai/node.amd.partitioning.enabled=true kaiwo.silogen.ai/node.amd.partitioning.profile=cpx
      - wait:
          apiVersion: kaiwo.silogen.ai/v1alpha1
          kind: KaiwoNode
          name: tw009
          timeout: 5m
          for:
            condition:
              name: PartitioningCompleted
              value: 'true'
      - assert:
          resource:
            apiVersion: kaiwo.silogen.ai/v1alpha1
            kind: KaiwoNode
            metadata:
              name: tw009
            spec:
              partitioning:
                profile: cpx
            status:
              status: Ready
              partitioning:
                phase: Completed
                appliedProfile: cpx
              resources:
                gpus:
                  isPartitioned: true
                  logicalCount: 63
                  logicalVramPerGpu: 24Gi
      - script:
          # Reset the KaiwoQueueConfig
          content: kubectl delete kaiwoqueueconfig kaiwo
      - sleep:
          duration: 5s
  - name: Run partitioned jobs
    try:
    - apply:
        file: kaiwojob-partitioned.yaml
    - apply:
        file: kaiwojob-non-partitioned.yaml
    - assert:
        resource:
          apiVersion: v1
          kind: Pod
          metadata:
            labels:
              kaiwo.silogen.ai/name: partitioned
          spec:
            nodeName: tw009
    - assert:
        resource:
          apiVersion: v1
          kind: Pod
          metadata:
            labels:
              kaiwo.silogen.ai/name: non-partitioned
          spec:
            nodeName: tw038
  - name: Ensure partitioning is disabled
    try:
      - script:
          content: kubectl label nodes tw009 --overwrite kaiwo.silogen.ai/node.amd.partitioning.enabled=true kaiwo.silogen.ai/node.amd.partitioning.profile=spx
      - sleep:
          duration: 10s
      - wait:
          apiVersion: kaiwo.silogen.ai/v1alpha1
          kind: KaiwoNode
          name: tw009
          timeout: 5m
          for:
            condition:
              name: PartitioningCompleted
              value: 'true'
      - assert:
          resource:
            apiVersion: kaiwo.silogen.ai/v1alpha1
            kind: KaiwoNode
            metadata:
              name: tw009
            spec:
              partitioning:
                profile: spx
            status:
              status: Ready
              partitioning:
                phase: Completed
                appliedProfile: spx
              resources:
                gpus:
                  isPartitioned: false
                  logicalCount: 8
                  logicalVramPerGpu: 192Gi
    finally:
      - script:
          # Reset the KaiwoQueueConfig
          content: kubectl delete kaiwoqueueconfig kaiwo
      - sleep:
          duration: 5s
